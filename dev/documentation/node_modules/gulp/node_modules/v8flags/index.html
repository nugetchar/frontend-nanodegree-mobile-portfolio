<!DOCTYPE html>

<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>this entire module is depressing. i should have spent my time learning
how to patch v8 so that these options would just be available on the
process object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> execFile = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>).execFile;
<span class="hljs-keyword">const</span> env = process.env;
<span class="hljs-keyword">const</span> user = env.LOGNAME || env.USER || env.LNAME || env.USERNAME;
<span class="hljs-keyword">const</span> configfile = <span class="hljs-string">'.v8flags.'</span>+process.versions.v8+<span class="hljs-string">'.'</span>+user+<span class="hljs-string">'.json'</span>;
<span class="hljs-keyword">const</span> exclusions = [<span class="hljs-string">'--help'</span>];

<span class="hljs-keyword">const</span> failureMessage = [
  <span class="hljs-string">'Unable to cache a config file for v8flags to a your home directory'</span>,
  <span class="hljs-string">'or a temporary folder. To fix this problem, please correct your'</span>,
  <span class="hljs-string">'environment by setting HOME=/path/to/home or TEMP=/path/to/temp.'</span>,
  <span class="hljs-string">'NOTE: the user running this must be able to access provided path.'</span>,
  <span class="hljs-string">'If all else fails, please open an issue here:'</span>,
  <span class="hljs-string">'http://github.com/tkellen/js-v8flags'</span>
].join(<span class="hljs-string">'\n'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fail</span> (<span class="hljs-params">err</span>) </span>{
  err.message += <span class="hljs-string">'\n\n'</span> + failureMessage;
  <span class="hljs-keyword">return</span> err;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">openConfig</span> (<span class="hljs-params">cb</span>) </span>{
  <span class="hljs-keyword">var</span> userHome = <span class="hljs-built_in">require</span>(<span class="hljs-string">'user-home'</span>);
  <span class="hljs-keyword">var</span> configpath = path.join(userHome || os.tmpdir(), configfile);
  <span class="hljs-keyword">var</span> content;
  <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>if the config file is valid, it should be json and therefore
node should be able to require it directly. if this doesn’t
throw, we’re done!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    content = <span class="hljs-built_in">require</span>(configpath);
    process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      cb(<span class="hljs-literal">null</span>, content);
    });
  } <span class="hljs-keyword">catch</span> (e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>if requiring the config file failed, maybe it doesn’t exist, or
perhaps it has become corrupted. instead of calling back with the
content of the file, call back with a file descriptor that we can
write the cached data to</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fs.open(configpath, <span class="hljs-string">'w+'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, fd</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> cb(err);
      }
      <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, fd);
    });
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>i can’t wait for the day this whole module is obsolete because these
options are available on the process object. this executes node with
<code>--v8-options</code> and parses the result, returning an array of command
line flags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFlags</span> (<span class="hljs-params">cb</span>) </span>{
  execFile(process.execPath, [<span class="hljs-string">'--v8-options'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">execErr, result</span>) </span>{
    <span class="hljs-keyword">if</span> (execErr) {
      <span class="hljs-keyword">return</span> cb(execErr);
    }
    <span class="hljs-keyword">var</span> flags = result.match(<span class="hljs-regexp">/\s\s--(\w+)/gm</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">match</span>) </span>{
      <span class="hljs-keyword">return</span> match.substring(<span class="hljs-number">2</span>);
    }).filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) </span>{
      <span class="hljs-keyword">return</span> exclusions.indexOf(name) === -<span class="hljs-number">1</span>;
    });
    <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, flags);
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>write some json to a file descriptor. if this fails, call back
with both the error and the data that was meant to be written.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeConfig</span> (<span class="hljs-params">fd, flags, cb</span>) </span>{
  <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-built_in">JSON</span>.stringify(flags));
  <span class="hljs-keyword">return</span> fs.write(fd, buf, <span class="hljs-number">0</span>, buf.length, <span class="hljs-number">0</span> , <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">writeErr</span>) </span>{
    fs.close(fd, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">closeErr</span>) </span>{
      <span class="hljs-keyword">var</span> err = writeErr || closeErr;
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> cb(fail(err), flags);
      }
      <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, flags);
    });
  });
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cb</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>bail early if this is not node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> isElectron = process.versions &amp;&amp; process.versions.electron;
  <span class="hljs-keyword">if</span> (isElectron) {
    <span class="hljs-keyword">return</span> process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      cb(<span class="hljs-literal">null</span>, []);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>attempt to open/read cache file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  openConfig(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">openErr, result</span>) </span>{
    <span class="hljs-keyword">if</span> (!openErr &amp;&amp; <span class="hljs-keyword">typeof</span> result !== <span class="hljs-string">'number'</span>) {
      <span class="hljs-keyword">return</span> cb(<span class="hljs-literal">null</span>, result);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>if the result is not an array, we need to go fetch
the flags by invoking node with <code>--v8-options</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getFlags(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">flagsErr, flags</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>if there was an error fetching the flags, bail immediately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (flagsErr) {
        <span class="hljs-keyword">return</span> cb(flagsErr);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>if there was a problem opening the config file for writing
throw an error but include the flags anyway so that users
can continue to execute (at the expense of having to fetch
flags on every run until they fix the underyling problem).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (openErr) {
        <span class="hljs-keyword">return</span> cb(fail(openErr), flags);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>write the config file to disk so subsequent runs can read
flags out of a cache file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> writeConfig(result, flags, cb);
    });
  });
};

<span class="hljs-built_in">module</span>.exports.configfile = configfile;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
