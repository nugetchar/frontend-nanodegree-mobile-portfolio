<!DOCTYPE html>

<html>
<head>
  <title>PluginError.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>PluginError.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> arrayDiffer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'array-differ'</span>);
<span class="hljs-keyword">var</span> arrayUniq = <span class="hljs-built_in">require</span>(<span class="hljs-string">'array-uniq'</span>);
<span class="hljs-keyword">var</span> chalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chalk'</span>);
<span class="hljs-keyword">var</span> objectAssign = <span class="hljs-built_in">require</span>(<span class="hljs-string">'object-assign'</span>);

<span class="hljs-keyword">var</span> nonEnumberableProperties = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'message'</span>, <span class="hljs-string">'stack'</span>];
<span class="hljs-keyword">var</span> propertiesNotToDisplay = nonEnumberableProperties.concat([<span class="hljs-string">'plugin'</span>, <span class="hljs-string">'showStack'</span>, <span class="hljs-string">'showProperties'</span>, <span class="hljs-string">'__safety'</span>, <span class="hljs-string">'_stack'</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>wow what a clusterfuck</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> parseOptions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">plugin, message, opt</span>) </span>{
  opt = opt || {};
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> plugin === <span class="hljs-string">'object'</span>) {
    opt = plugin;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) {
      opt.error = message;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> message === <span class="hljs-string">'object'</span>) {
      opt = message;
    } <span class="hljs-keyword">else</span> {
      opt.message = message;
    }
    opt.plugin = plugin;
  }

  <span class="hljs-keyword">return</span> objectAssign({
    showStack: <span class="hljs-literal">false</span>,
    showProperties: <span class="hljs-literal">true</span>
  }, opt);
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PluginError</span>(<span class="hljs-params">plugin, message, opt</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> PluginError)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Call PluginError using new'</span>);

  <span class="hljs-built_in">Error</span>.call(<span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">var</span> options = parseOptions(plugin, message, opt);
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>if options has an error, grab details from it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (options.error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>These properties are not enumerable, so we have to add them explicitly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    arrayUniq(<span class="hljs-built_in">Object</span>.keys(options.error).concat(nonEnumberableProperties))
      .forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prop</span>) </span>{
        self[prop] = options.error[prop];
      });
  }

  <span class="hljs-keyword">var</span> properties = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'message'</span>, <span class="hljs-string">'fileName'</span>, <span class="hljs-string">'lineNumber'</span>, <span class="hljs-string">'stack'</span>, <span class="hljs-string">'showStack'</span>, <span class="hljs-string">'showProperties'</span>, <span class="hljs-string">'plugin'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>options object can override</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  properties.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prop</span>) </span>{
    <span class="hljs-keyword">if</span> (prop <span class="hljs-keyword">in</span> options) <span class="hljs-keyword">this</span>[prop] = options[prop];
  }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.name) <span class="hljs-keyword">this</span>.name = <span class="hljs-string">'Error'</span>;

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.stack) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Error.captureStackTrace appends a stack property which relies on the toString method of the object it is applied to.
Since we are using our own toString method which controls when to display the stack trace if we don’t go through this
safety object, then we’ll get stack overflow problems.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> safety = {
      toString: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._messageWithDetails() + <span class="hljs-string">'\nStack:'</span>;
      }.bind(<span class="hljs-keyword">this</span>)
    };
    <span class="hljs-built_in">Error</span>.captureStackTrace(safety, <span class="hljs-built_in">arguments</span>.callee || <span class="hljs-keyword">this</span>.constructor);
    <span class="hljs-keyword">this</span>.__safety = safety;
  }

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.plugin) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Missing plugin name'</span>);
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.message) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Missing error message'</span>);
}

util.inherits(PluginError, <span class="hljs-built_in">Error</span>);

PluginError.prototype._messageWithDetails = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> messageWithDetails = <span class="hljs-string">'Message:\n    '</span> + <span class="hljs-keyword">this</span>.message;
  <span class="hljs-keyword">var</span> details = <span class="hljs-keyword">this</span>._messageDetails();

  <span class="hljs-keyword">if</span> (details !== <span class="hljs-string">''</span>) {
    messageWithDetails += <span class="hljs-string">'\n'</span> + details;
  }

  <span class="hljs-keyword">return</span> messageWithDetails;
};

PluginError.prototype._messageDetails = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.showProperties) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }

  <span class="hljs-keyword">var</span> properties = arrayDiffer(<span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>), propertiesNotToDisplay);

  <span class="hljs-keyword">if</span> (properties.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }

  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  properties = properties.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stringifyProperty</span>(<span class="hljs-params">prop</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'    '</span> + prop + <span class="hljs-string">': '</span> + self[prop];
  });

  <span class="hljs-keyword">return</span> <span class="hljs-string">'Details:\n'</span> + properties.join(<span class="hljs-string">'\n'</span>);
};

PluginError.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> sig = chalk.red(<span class="hljs-keyword">this</span>.name) + <span class="hljs-string">' in plugin \''</span> + chalk.cyan(<span class="hljs-keyword">this</span>.plugin) + <span class="hljs-string">'\''</span>;
  <span class="hljs-keyword">var</span> detailsWithStack = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stack</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._messageWithDetails() + <span class="hljs-string">'\nStack:\n'</span> + stack;
  }.bind(<span class="hljs-keyword">this</span>);

  <span class="hljs-keyword">var</span> msg;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.showStack) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.__safety) { <span class="hljs-comment">// There is no wrapped error, use the stack captured in the PluginError ctor</span>
      msg = <span class="hljs-keyword">this</span>.__safety.stack;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._stack) {
      msg = detailsWithStack(<span class="hljs-keyword">this</span>._stack);
    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Stack from wrapped error</span>
      msg = detailsWithStack(<span class="hljs-keyword">this</span>.stack);
    }
  } <span class="hljs-keyword">else</span> {
    msg = <span class="hljs-keyword">this</span>._messageWithDetails();
  }

  <span class="hljs-keyword">return</span> sig + <span class="hljs-string">'\n'</span> + msg;
};

<span class="hljs-built_in">module</span>.exports = PluginError;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
