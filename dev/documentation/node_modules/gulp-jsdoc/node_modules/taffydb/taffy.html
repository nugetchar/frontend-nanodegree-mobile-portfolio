<!DOCTYPE html>

<html>
<head>
  <title>taffy.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>taffy.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*

 Software License Agreement (BSD License)
 http://taffydb.com
 Copyright (c)
 All rights reserved.


 Redistribution and use of this software in source and binary forms, with or without modification, are permitted provided that the following condition is met:

 * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.

 THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

 */</span>

<span class="hljs-comment">/*jslint        browser : true, continue : true,
 devel  : true, indent  : 2,    maxerr   : 500,
 newcap : true, nomen   : true, plusplus : true,
 regexp : true, sloppy  : true, vars     : false,
 white  : true
*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>BUILD 193d48d, modified by mmikowski to pass jslint</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Setup TAFFY name space to return an object with methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> TAFFY, exports, T;
(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<span class="hljs-pi">
  'use strict'</span>;
  <span class="hljs-keyword">var</span>
    typeList,     makeTest,     idx,    typeKey,
    version,      TC,           idpad,  cmax,
    API,          protectJSON,  each,   eachin,
    isIndexable,  returnFilter, runFilters,
    numcharsplit, orderByCol,   run,    intersection,
    filter,       makeCid,      safeForJson,
    isRegexp
    ;


  <span class="hljs-keyword">if</span> ( ! TAFFY ){</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>TC = Counter for Taffy DBs on page, used for unique IDs
cmax = size of charnumarray conversion cache
idpad = zeros to pad record IDs with</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    version = <span class="hljs-string">'2.7'</span>;
    TC      = <span class="hljs-number">1</span>;
    idpad   = <span class="hljs-string">'000000'</span>;
    cmax    = <span class="hljs-number">1000</span>;
    API     = {};

    protectJSON = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> t </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: a variable</li>
<li>Returns: the variable if object/array or the parsed variable if JSON
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( TAFFY.isArray( t ) || TAFFY.isObject( t ) ){
        <span class="hljs-keyword">return</span> t;
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse( t );
      }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>gracefully stolen from underscore.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    intersection = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">array1, array2</span>) </span>{
        <span class="hljs-keyword">return</span> filter(array1, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
          <span class="hljs-keyword">return</span> array2.indexOf(item) &gt;= <span class="hljs-number">0</span>;
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>gracefully stolen from underscore.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    filter = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, iterator, context</span>) </span>{
        <span class="hljs-keyword">var</span> results = [];
        <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> results;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.prototype.filter &amp;&amp; obj.filter === <span class="hljs-built_in">Array</span>.prototype.filter) <span class="hljs-keyword">return</span> obj.filter(iterator, context);
        each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, index, list</span>) </span>{
          <span class="hljs-keyword">if</span> (iterator.call(context, value, index, list)) results[results.length] = value;
        });
        <span class="hljs-keyword">return</span> results;
    };
    
    isRegexp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">aObj</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(aObj)===<span class="hljs-string">'[object RegExp]'</span>;
    }
    
    safeForJson = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">aObj</span>) </span>{
        <span class="hljs-keyword">var</span> myResult = T.isArray(aObj) ? [] : T.isObject(aObj) ? {} : <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span>(aObj===<span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> aObj;
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> aObj) {
            myResult[i]  = isRegexp(aObj[i]) ? aObj[i].toString() : T.isArray(aObj[i]) || T.isObject(aObj[i]) ? safeForJson(aObj[i]) : aObj[i];
        }
        <span class="hljs-keyword">return</span> myResult;
    }
    
    makeCid = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">aContext</span>) </span>{
        <span class="hljs-keyword">var</span> myCid = <span class="hljs-built_in">JSON</span>.stringify(aContext);
        <span class="hljs-keyword">if</span>(myCid.match(<span class="hljs-regexp">/regex/</span>)===<span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> myCid;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(safeForJson(aContext));
    }
    
    each = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> a, fun, u </span>) </span>{
      <span class="hljs-keyword">var</span> r, i, x, y;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes:</li>
<li>a = an object/value or an array of objects/values</li>
<li>f = a function</li>
<li>u = optional flag to describe how to handle undefined values
in array of values. True: pass them to the functions,
False: skip. Default False;</li>
<li>Purpose: Used to loop over arrays
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( a &amp;&amp; ((T.isArray( a ) &amp;&amp; a.length === <span class="hljs-number">1</span>) || (!T.isArray( a ))) ){
        fun( (T.isArray( a )) ? a[<span class="hljs-number">0</span>] : a, <span class="hljs-number">0</span> );
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> ( r, i, x = <span class="hljs-number">0</span>, a = (T.isArray( a )) ? a : [a], y = a.length;
              x &lt; y; x++ )
        {
          i = a[x];
          <span class="hljs-keyword">if</span> ( !T.isUndefined( i ) || (u || <span class="hljs-literal">false</span>) ){
            r = fun( i, x );
            <span class="hljs-keyword">if</span> ( r === T.EXIT ){
              <span class="hljs-keyword">break</span>;
            }

          }
        }
      }
    };

    eachin = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> o, fun </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes:</li>
<li>o = an object</li>
<li>f = a function</li>
<li>Purpose: Used to loop over objects
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>, r, i;

      <span class="hljs-keyword">for</span> ( i <span class="hljs-keyword">in</span> o ){
        <span class="hljs-keyword">if</span> ( o.hasOwnProperty( i ) ){
          r = fun( o[i], i, x++ );
          <span class="hljs-keyword">if</span> ( r === T.EXIT ){
            <span class="hljs-keyword">break</span>;
          }
        }
      }

    };

    API.extend = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> m, f </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: method name, function</li>
<li>Purpose: Add a custom method to the API
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      API[m] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> f.apply( <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span> );
      };
    };

    isIndexable = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f </span>) </span>{
      <span class="hljs-keyword">var</span> i;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Check to see if record ID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( T.isString( f ) &amp;&amp; <span class="hljs-regexp">/[t][0-9]*[r][0-9]*/i</span>.test( f ) ){
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Check to see if record</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( T.isObject( f ) &amp;&amp; f.___id &amp;&amp; f.___s ){
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Check to see if array of indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( T.isArray( f ) ){
        i = <span class="hljs-literal">true</span>;
        each( f, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
          <span class="hljs-keyword">if</span> ( !isIndexable( r ) ){
            i = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">return</span> TAFFY.EXIT;
          }
        });
        <span class="hljs-keyword">return</span> i;
      }

      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    };

    runFilters = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r, filter </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: takes a record and a collection of filters</li>
<li>Returns: true if the record matches, false otherwise</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> match = <span class="hljs-literal">true</span>;


      each( filter, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> mf </span>) </span>{
        <span class="hljs-keyword">switch</span> ( T.typeOf( mf ) ){
          <span class="hljs-keyword">case</span> <span class="hljs-string">'function'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>run function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( !mf.apply( r ) ){
              match = <span class="hljs-literal">false</span>;
              <span class="hljs-keyword">return</span> TAFFY.EXIT;
            }
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'array'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>loop array and treat like a SQL or</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            match = (mf.length === <span class="hljs-number">1</span>) ? (runFilters( r, mf[<span class="hljs-number">0</span>] )) :
              (mf.length === <span class="hljs-number">2</span>) ? (runFilters( r, mf[<span class="hljs-number">0</span>] ) ||
                runFilters( r, mf[<span class="hljs-number">1</span>] )) :
                (mf.length === <span class="hljs-number">3</span>) ? (runFilters( r, mf[<span class="hljs-number">0</span>] ) ||
                  runFilters( r, mf[<span class="hljs-number">1</span>] ) || runFilters( r, mf[<span class="hljs-number">2</span>] )) :
                  (mf.length === <span class="hljs-number">4</span>) ? (runFilters( r, mf[<span class="hljs-number">0</span>] ) ||
                    runFilters( r, mf[<span class="hljs-number">1</span>] ) || runFilters( r, mf[<span class="hljs-number">2</span>] ) ||
                    runFilters( r, mf[<span class="hljs-number">3</span>] )) : <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">if</span> ( mf.length &gt; <span class="hljs-number">4</span> ){
              each( mf, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f </span>) </span>{
                <span class="hljs-keyword">if</span> ( runFilters( r, f ) ){
                  match = <span class="hljs-literal">true</span>;
                }
              });
            }
            <span class="hljs-keyword">break</span>;
        }
      });

      <span class="hljs-keyword">return</span> match;
    };

    returnFilter = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: filter object</li>
<li>Returns: a filter function</li>
<li>Purpose: Take a filter object and return a function that can be used to compare</li>
<li>a TaffyDB record to see if the record matches a query</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> nf = [];
      <span class="hljs-keyword">if</span> ( T.isString( f ) &amp;&amp; <span class="hljs-regexp">/[t][0-9]*[r][0-9]*/i</span>.test( f ) ){
        f = { ___id : f };
      }
      <span class="hljs-keyword">if</span> ( T.isArray( f ) ){</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>if we are working with an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        each( f, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>loop the array and return a filter func for each value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          nf.push( returnFilter( r ) );
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>now build a func to loop over the filters and return true if ANY of the filters match
This handles logical OR expressions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        f = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>, match = <span class="hljs-literal">false</span>;
          each( nf, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f </span>) </span>{
            <span class="hljs-keyword">if</span> ( runFilters( that, f ) ){
              match = <span class="hljs-literal">true</span>;
            }
          });
          <span class="hljs-keyword">return</span> match;
        };
        <span class="hljs-keyword">return</span> f;

      }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>if we are dealing with an Object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( T.isObject( f ) ){
        <span class="hljs-keyword">if</span> ( T.isObject( f ) &amp;&amp; f.___id &amp;&amp; f.___s ){
          f = { ___id : f.___id };
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Loop over each value on the object to prep match type and match value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        eachin( f, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, i </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>default match type to IS/Equals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( !T.isObject( v ) ){
            v = {
              <span class="hljs-string">'is'</span> : v
            };
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>loop over each value on the value object  - if any</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          eachin( v, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> mtest, s </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>s = match type, e.g. is, hasAll, like, etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> c = [], looper;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>function to loop and apply filter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            looper = (s === <span class="hljs-string">'hasAll'</span>) ?
              <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> mtest, func </span>) </span>{
                func( mtest );
              } : each;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>loop over each test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            looper( mtest, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> mtest </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>su = match success
f = match false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">var</span> su = <span class="hljs-literal">true</span>, f = <span class="hljs-literal">false</span>, matchFunc;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>push a function onto the filter collection to do the matching</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              matchFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>get the value from the record</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span>
                  mvalue   = <span class="hljs-keyword">this</span>[i],
                  eqeq     = <span class="hljs-string">'=='</span>,
                  bangeq   = <span class="hljs-string">'!='</span>,
                  eqeqeq   = <span class="hljs-string">'==='</span>,
                  lt   = <span class="hljs-string">'&lt;'</span>,
                  gt   = <span class="hljs-string">'&gt;'</span>,
                  lteq   = <span class="hljs-string">'&lt;='</span>,
                  gteq   = <span class="hljs-string">'&gt;='</span>,
                  bangeqeq = <span class="hljs-string">'!=='</span>,
                  r
                  ;

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> mvalue === <span class="hljs-string">'undefined'</span>) {
                  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                
                <span class="hljs-keyword">if</span> ( (s.indexOf( <span class="hljs-string">'!'</span> ) === <span class="hljs-number">0</span>) &amp;&amp; s !== bangeq &amp;&amp;
                  s !== bangeqeq )
                {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>if the filter name starts with ! as in ‘!is’ then reverse the match logic and remove the !</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  su = <span class="hljs-literal">false</span>;
                  s = s.substring( <span class="hljs-number">1</span>, s.length );
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>get the match results based on the s/match type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-comment">/*jslint eqeq : true */</span>
                r = (
                  (s === <span class="hljs-string">'regex'</span>) ? (mtest.test( mvalue )) : (s === <span class="hljs-string">'lt'</span> || s === lt)
                  ? (mvalue &lt; mtest)  : (s === <span class="hljs-string">'gt'</span> || s === gt)
                  ? (mvalue &gt; mtest)  : (s === <span class="hljs-string">'lte'</span> || s === lteq)
                  ? (mvalue &lt;= mtest) : (s === <span class="hljs-string">'gte'</span> || s === gteq)
                  ? (mvalue &gt;= mtest) : (s === <span class="hljs-string">'left'</span>)
                  ? (mvalue.indexOf( mtest ) === <span class="hljs-number">0</span>) : (s === <span class="hljs-string">'leftnocase'</span>)
                  ? (mvalue.toLowerCase().indexOf( mtest.toLowerCase() )
                    === <span class="hljs-number">0</span>) : (s === <span class="hljs-string">'right'</span>)
                  ? (mvalue.substring( (mvalue.length - mtest.length) )
                    === mtest) : (s === <span class="hljs-string">'rightnocase'</span>)
                  ? (mvalue.toLowerCase().substring(
                    (mvalue.length - mtest.length) ) === mtest.toLowerCase())
                    : (s === <span class="hljs-string">'like'</span>)
                  ? (mvalue.indexOf( mtest ) &gt;= <span class="hljs-number">0</span>) : (s === <span class="hljs-string">'likenocase'</span>)
                  ? (mvalue.toLowerCase().indexOf(mtest.toLowerCase()) &gt;= <span class="hljs-number">0</span>)
                    : (s === eqeqeq || s === <span class="hljs-string">'is'</span>)
                  ? (mvalue ===  mtest) : (s === eqeq)
                  ? (mvalue == mtest) : (s === bangeqeq)
                  ? (mvalue !==  mtest) : (s === bangeq)
                  ? (mvalue != mtest) : (s === <span class="hljs-string">'isnocase'</span>)
                  ? (mvalue.toLowerCase
                    ? mvalue.toLowerCase() === mtest.toLowerCase()
                      : mvalue === mtest) : (s === <span class="hljs-string">'has'</span>)
                  ? (T.has( mvalue, mtest )) : (s === <span class="hljs-string">'hasall'</span>)
                  ? (T.hasAll( mvalue, mtest )) : (s === <span class="hljs-string">'contains'</span>)
                  ? (TAFFY.isArray(mvalue) &amp;&amp; mvalue.indexOf(mtest) &gt; -<span class="hljs-number">1</span>) : (
                    s.indexOf( <span class="hljs-string">'is'</span> ) === -<span class="hljs-number">1</span>
                      &amp;&amp; !TAFFY.isNull( mvalue )
                      &amp;&amp; !TAFFY.isUndefined( mvalue )
                      &amp;&amp; !TAFFY.isObject( mtest )
                      &amp;&amp; !TAFFY.isArray( mtest )
                    )
                  ? (mtest === mvalue[s])
                    : (T[s] &amp;&amp; T.isFunction( T[s] )
                    &amp;&amp; s.indexOf( <span class="hljs-string">'is'</span> ) === <span class="hljs-number">0</span>)
                  ? T[s]( mvalue ) === mtest
                    : (T[s] &amp;&amp; T.isFunction( T[s] ))
                  ? T[s]( mvalue, mtest ) : (<span class="hljs-literal">false</span>)
                );
                <span class="hljs-comment">/*jslint eqeq : false */</span>
                r = (r &amp;&amp; !su) ? <span class="hljs-literal">false</span> : (!r &amp;&amp; !su) ? <span class="hljs-literal">true</span> : r;

                <span class="hljs-keyword">return</span> r;
              };
              c.push( matchFunc );

            });</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>if only one filter in the collection push it onto the filter list without the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( c.length === <span class="hljs-number">1</span> ){

              nf.push( c[<span class="hljs-number">0</span>] );
            }
            <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>else build a function to loop over all the filters and return true only if ALL match
this is a logical AND</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              nf.push( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>, match = <span class="hljs-literal">false</span>;
                each( c, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f </span>) </span>{
                  <span class="hljs-keyword">if</span> ( f.apply( that ) ){
                    match = <span class="hljs-literal">true</span>;
                  }
                });
                <span class="hljs-keyword">return</span> match;
              });
            }
          });
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>finally return a single function that wraps all the other functions and will run a query
where all functions have to return true for a record to appear in a query result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        f = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>, match = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>faster if less than  4 functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          match = (nf.length === <span class="hljs-number">1</span> &amp;&amp; !nf[<span class="hljs-number">0</span>].apply( that )) ? <span class="hljs-literal">false</span> :
            (nf.length === <span class="hljs-number">2</span> &amp;&amp;
              (!nf[<span class="hljs-number">0</span>].apply( that ) || !nf[<span class="hljs-number">1</span>].apply( that ))) ? <span class="hljs-literal">false</span> :
              (nf.length === <span class="hljs-number">3</span> &amp;&amp;
                (!nf[<span class="hljs-number">0</span>].apply( that ) || !nf[<span class="hljs-number">1</span>].apply( that ) ||
                  !nf[<span class="hljs-number">2</span>].apply( that ))) ? <span class="hljs-literal">false</span> :
                (nf.length === <span class="hljs-number">4</span> &amp;&amp;
                  (!nf[<span class="hljs-number">0</span>].apply( that ) || !nf[<span class="hljs-number">1</span>].apply( that ) ||
                    !nf[<span class="hljs-number">2</span>].apply( that ) || !nf[<span class="hljs-number">3</span>].apply( that ))) ? <span class="hljs-literal">false</span>
                  : <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">if</span> ( nf.length &gt; <span class="hljs-number">4</span> ){
            each( nf, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f </span>) </span>{
              <span class="hljs-keyword">if</span> ( !runFilters( that, f ) ){
                match = <span class="hljs-literal">false</span>;
              }
            });
          }
          <span class="hljs-keyword">return</span> match;
        };
        <span class="hljs-keyword">return</span> f;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>if function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( T.isFunction( f ) ){
        <span class="hljs-keyword">return</span> f;
      }
    };

    orderByCol = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> ar, o </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: takes an array and a sort object</li>
<li>Returns: the array sorted</li>
<li>Purpose: Accept filters such as “[col], [col2]” or “[col] desc” and sort on those columns
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-keyword">var</span> sortFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> a, b </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>function to pass to the native array.sort to sort an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> r = <span class="hljs-number">0</span>;

        T.each( o, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> sd </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>loop over the sort instructions
get the column name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> o, col, dir, c, d;
          o = sd.split( <span class="hljs-string">' '</span> );
          col = o[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>get the direction</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          dir = (o.length === <span class="hljs-number">1</span>) ? <span class="hljs-string">"logical"</span> : o[<span class="hljs-number">1</span>];


          <span class="hljs-keyword">if</span> ( dir === <span class="hljs-string">'logical'</span> ){</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>if dir is logical than grab the charnum arrays for the two values we are looking at</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            c = numcharsplit( a[col] );
            d = numcharsplit( b[col] );</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>loop over the charnumarrays until one value is higher than the other</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            T.each( (c.length &lt;= d.length) ? c : d, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> x, i </span>) </span>{
              <span class="hljs-keyword">if</span> ( c[i] &lt; d[i] ){
                r = -<span class="hljs-number">1</span>;
                <span class="hljs-keyword">return</span> TAFFY.EXIT;
              }
              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( c[i] &gt; d[i] ){
                r = <span class="hljs-number">1</span>;
                <span class="hljs-keyword">return</span> TAFFY.EXIT;
              }
            } );
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( dir === <span class="hljs-string">'logicaldesc'</span> ){</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>if logicaldesc than grab the charnum arrays for the two values we are looking at</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            c = numcharsplit( a[col] );
            d = numcharsplit( b[col] );</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>loop over the charnumarrays until one value is lower than the other</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            T.each( (c.length &lt;= d.length) ? c : d, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> x, i </span>) </span>{
              <span class="hljs-keyword">if</span> ( c[i] &gt; d[i] ){
                r = -<span class="hljs-number">1</span>;
                <span class="hljs-keyword">return</span> TAFFY.EXIT;
              }
              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( c[i] &lt; d[i] ){
                r = <span class="hljs-number">1</span>;
                <span class="hljs-keyword">return</span> TAFFY.EXIT;
              }
            } );
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( dir === <span class="hljs-string">'asec'</span> &amp;&amp; a[col] &lt; b[col] ){</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>if asec - default - check to see which is higher</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            r = -<span class="hljs-number">1</span>;
            <span class="hljs-keyword">return</span> T.EXIT;
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( dir === <span class="hljs-string">'asec'</span> &amp;&amp; a[col] &gt; b[col] ){</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>if asec - default - check to see which is higher</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            r = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">return</span> T.EXIT;
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( dir === <span class="hljs-string">'desc'</span> &amp;&amp; a[col] &gt; b[col] ){</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>if desc check to see which is lower</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            r = -<span class="hljs-number">1</span>;
            <span class="hljs-keyword">return</span> T.EXIT;

          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( dir === <span class="hljs-string">'desc'</span> &amp;&amp; a[col] &lt; b[col] ){</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>if desc check to see which is lower</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            r = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">return</span> T.EXIT;

          }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>if r is still 0 and we are doing a logical sort than look to see if one array is longer than the other</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( r === <span class="hljs-number">0</span> &amp;&amp; dir === <span class="hljs-string">'logical'</span> &amp;&amp; c.length &lt; d.length ){
            r = -<span class="hljs-number">1</span>;
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( r === <span class="hljs-number">0</span> &amp;&amp; dir === <span class="hljs-string">'logical'</span> &amp;&amp; c.length &gt; d.length ){
            r = <span class="hljs-number">1</span>;
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( r === <span class="hljs-number">0</span> &amp;&amp; dir === <span class="hljs-string">'logicaldesc'</span> &amp;&amp; c.length &gt; d.length ){
            r = -<span class="hljs-number">1</span>;
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( r === <span class="hljs-number">0</span> &amp;&amp; dir === <span class="hljs-string">'logicaldesc'</span> &amp;&amp; c.length &lt; d.length ){
            r = <span class="hljs-number">1</span>;
          }

          <span class="hljs-keyword">if</span> ( r !== <span class="hljs-number">0</span> ){
            <span class="hljs-keyword">return</span> T.EXIT;
          }


        } );
        <span class="hljs-keyword">return</span> r;
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>call the sort function and return the newly sorted array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> (ar &amp;&amp; ar.push) ? ar.sort( sortFunc ) : ar;


    };</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: a string containing numbers and letters and turn it into an array</li>
<li>Returns: return an array of numbers and letters</li>
<li>Purpose: Used for logical sorting. String Example: 12ABC results: [12,’ABC’]</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>creates a cache for numchar conversions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> cache = {}, cachcounter = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>creates the numcharsplit function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      numcharsplit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> thing </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>if over 1000 items exist in the cache, clear it and start over</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( cachcounter &gt; cmax ){
          cache = {};
          cachcounter = <span class="hljs-number">0</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>if a cache can be found for a numchar then return its array value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> cache[<span class="hljs-string">'_'</span> + thing] || (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>otherwise do the conversion
make sure it is a string and setup so other variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> nthing = <span class="hljs-built_in">String</span>( thing ),
            na = [],
            rv = <span class="hljs-string">'_'</span>,
            rt = <span class="hljs-string">''</span>,
            x, xx, c;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>loop over the string char by char</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">for</span> ( x = <span class="hljs-number">0</span>, xx = nthing.length; x &lt; xx; x++ ){</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>take the char at each location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            c = nthing.charCodeAt( x );</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>check to see if it is a valid number char and append it to the array.
if last char was a string push the string to the charnum array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( ( c &gt;= <span class="hljs-number">48</span> &amp;&amp; c &lt;= <span class="hljs-number">57</span> ) || c === <span class="hljs-number">46</span> ){
              <span class="hljs-keyword">if</span> ( rt !== <span class="hljs-string">'n'</span> ){
                rt = <span class="hljs-string">'n'</span>;
                na.push( rv.toLowerCase() );
                rv = <span class="hljs-string">''</span>;
              }
              rv = rv + nthing.charAt( x );
            }
            <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>check to see if it is a valid string char and append to string
if last char was a number push the whole number to the charnum array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> ( rt !== <span class="hljs-string">'s'</span> ){
                rt = <span class="hljs-string">'s'</span>;
                na.push( <span class="hljs-built_in">parseFloat</span>( rv ) );
                rv = <span class="hljs-string">''</span>;
              }
              rv = rv + nthing.charAt( x );
            }
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>once done, push the last value to the charnum array and remove the first uneeded item</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          na.push( (rt === <span class="hljs-string">'n'</span>) ? <span class="hljs-built_in">parseFloat</span>( rv ) : rv.toLowerCase() );
          na.shift();</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>add to cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          cache[<span class="hljs-string">'_'</span> + thing] = na;
          cachcounter++;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>return charnum array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> na;
        }());
      };
    }());</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Runs a query</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>

    run = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">this</span>.context( {
        results : <span class="hljs-keyword">this</span>.getDBI().query( <span class="hljs-keyword">this</span>.context() )
      });

    };

    API.extend( <span class="hljs-string">'filter'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: takes unlimited filter objects as arguments</li>
<li>Returns: method collection</li>
<li>Purpose: Take filters as objects and cache functions for later lookup when a query is run</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span>
        nc = TAFFY.mergeObj( <span class="hljs-keyword">this</span>.context(), { run : <span class="hljs-literal">null</span> } ),
        nq = []
      ;
      each( nc.q, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v </span>) </span>{
        nq.push( v );
      });
      nc.q = nq;</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Hadnle passing of ___ID or a record on lookup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      each( <span class="hljs-built_in">arguments</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f </span>) </span>{
        nc.q.push( returnFilter( f ) );
        nc.filterRaw.push( f );
      });

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getroot( nc );
    });

    API.extend( <span class="hljs-string">'order'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> o </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Purpose: takes a string and creates an array of order instructions to be used with a query</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      o = o.split( <span class="hljs-string">','</span> );
      <span class="hljs-keyword">var</span> x = [], nc;

      each( o, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
        x.push( r.replace( <span class="hljs-regexp">/^\s*/</span>, <span class="hljs-string">''</span> ).replace( <span class="hljs-regexp">/\s*$/</span>, <span class="hljs-string">''</span> ) );
      });

      nc = TAFFY.mergeObj( <span class="hljs-keyword">this</span>.context(), {sort : <span class="hljs-literal">null</span>} );
      nc.order = x;

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getroot( nc );
    });

    API.extend( <span class="hljs-string">'limit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> n </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Purpose: takes a limit number to limit the number of rows returned by a query. Will update the results</li>
<li>of a query</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> nc = TAFFY.mergeObj( <span class="hljs-keyword">this</span>.context(), {}),
        limitedresults
        ;

      nc.limit = n;

      <span class="hljs-keyword">if</span> ( nc.run &amp;&amp; nc.sort ){
        limitedresults = [];
        each( nc.results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> i, x </span>) </span>{
          <span class="hljs-keyword">if</span> ( (x + <span class="hljs-number">1</span>) &gt; n ){
            <span class="hljs-keyword">return</span> TAFFY.EXIT;
          }
          limitedresults.push( i );
        });
        nc.results = limitedresults;
      }

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getroot( nc );
    });

    API.extend( <span class="hljs-string">'start'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> n </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Purpose: takes a limit number to limit the number of rows returned by a query. Will update the results</li>
<li>of a query</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> nc = TAFFY.mergeObj( <span class="hljs-keyword">this</span>.context(), {} ),
        limitedresults
        ;

      nc.start = n;

      <span class="hljs-keyword">if</span> ( nc.run &amp;&amp; nc.sort &amp;&amp; !nc.limit ){
        limitedresults = [];
        each( nc.results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> i, x </span>) </span>{
          <span class="hljs-keyword">if</span> ( (x + <span class="hljs-number">1</span>) &gt; n ){
            limitedresults.push( i );
          }
        });
        nc.results = limitedresults;
      }
      <span class="hljs-keyword">else</span> {
        nc = TAFFY.mergeObj( <span class="hljs-keyword">this</span>.context(), {run : <span class="hljs-literal">null</span>, start : n} );
      }

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getroot( nc );
    });

    API.extend( <span class="hljs-string">'update'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> arg0, arg1, arg2 </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: a object and passes it off DBI update method for all matched records</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> runEvent = <span class="hljs-literal">true</span>, o = {}, args = <span class="hljs-built_in">arguments</span>, that;
      <span class="hljs-keyword">if</span> ( TAFFY.isString( arg0 ) &amp;&amp;
        (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">2</span> || <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">3</span>) )
      {
        o[arg0] = arg1;
        <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">3</span> ){
          runEvent = arg2;
        }
      }
      <span class="hljs-keyword">else</span> {
        o = arg0;
        <span class="hljs-keyword">if</span> ( args.length === <span class="hljs-number">2</span> ){
          runEvent = arg1;
        }
      }

      that = <span class="hljs-keyword">this</span>;
      run.call( <span class="hljs-keyword">this</span> );
      each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
        <span class="hljs-keyword">var</span> c = o;
        <span class="hljs-keyword">if</span> ( TAFFY.isFunction( c ) ){
          c = c.apply( TAFFY.mergeObj( r, {} ) );
        }
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> ( T.isFunction( c ) ){
            c = c( TAFFY.mergeObj( r, {} ) );
          }
        }
        <span class="hljs-keyword">if</span> ( TAFFY.isObject( c ) ){
          that.getDBI().update( r.___id, c, runEvent );
        }
      });
      <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.context().results.length ){
        <span class="hljs-keyword">this</span>.context( { run : <span class="hljs-literal">null</span> });
      }
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    });
    API.extend( <span class="hljs-string">'remove'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> runEvent </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Purpose: removes records from the DB via the remove and removeCommit DBI methods</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>, c = <span class="hljs-number">0</span>;
      run.call( <span class="hljs-keyword">this</span> );
      each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
        that.getDBI().remove( r.___id );
        c++;
      });
      <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.context().results.length ){
        <span class="hljs-keyword">this</span>.context( {
          run : <span class="hljs-literal">null</span>
        });
        that.getDBI().removeCommit( runEvent );
      }

      <span class="hljs-keyword">return</span> c;
    });


    API.extend( <span class="hljs-string">'count'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Returns: The length of a query result</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      run.call( <span class="hljs-keyword">this</span> );
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.context().results.length;
    });

    API.extend( <span class="hljs-string">'callback'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f, delay </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Returns null;</li>
<li>Runs a function on return of run.call</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ( f ){
        <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
        setTimeout( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
          run.call( that );
          f.call( that.getroot( that.context() ) );
        }, delay || <span class="hljs-number">0</span> );
      }


      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    });

    API.extend( <span class="hljs-string">'get'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Returns: An array of all matching records</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      run.call( <span class="hljs-keyword">this</span> );
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.context().results;
    });

    API.extend( <span class="hljs-string">'stringify'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Returns: An JSON string of all matching records</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify( <span class="hljs-keyword">this</span>.get() );
    });
    API.extend( <span class="hljs-string">'first'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Returns: The first matching record</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      run.call( <span class="hljs-keyword">this</span> );
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.context().results[<span class="hljs-number">0</span>] || <span class="hljs-literal">false</span>;
    });
    API.extend( <span class="hljs-string">'last'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Returns: The last matching record</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      run.call( <span class="hljs-keyword">this</span> );
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.context().results[<span class="hljs-keyword">this</span>.context().results.length - <span class="hljs-number">1</span>] ||
        <span class="hljs-literal">false</span>;
    });


    API.extend( <span class="hljs-string">'sum'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: column to sum up</li>
<li>Returns: Sums the values of a column</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> total = <span class="hljs-number">0</span>, that = <span class="hljs-keyword">this</span>;
      run.call( that );
      each( <span class="hljs-built_in">arguments</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> c </span>) </span>{
        each( that.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
          total = total + (r[c] || <span class="hljs-number">0</span>);
        });
      });
      <span class="hljs-keyword">return</span> total;
    });

    API.extend( <span class="hljs-string">'min'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> c </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: column to find min</li>
<li>Returns: the lowest value</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> lowest = <span class="hljs-literal">null</span>;
      run.call( <span class="hljs-keyword">this</span> );
      each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
        <span class="hljs-keyword">if</span> ( lowest === <span class="hljs-literal">null</span> || r[c] &lt; lowest ){
          lowest = r[c];
        }
      });
      <span class="hljs-keyword">return</span> lowest;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <h1 id="-taffy-innerjoin-extension-ocd-edition-"> Taffy innerJoin Extension (OCD edition)</h1>
<p> How to Use</p>
<hr>
<p> left_table.innerJoin( right_table, condition1 &lt;,… conditionN&gt; )</p>
<p> A condition can take one of 2 forms:</p>
<ol>
<li><p>An ARRAY with 2 or 3 values:
A column name from the left table, an optional comparison string,
and column name from the right table.  The condition passes if the test
indicated is true.   If the condition string is omitted, ‘===’ is assumed.
EXAMPLES: [ ‘last_used_time’, ‘&gt;=’, ‘current_use_time’ ], [ ‘user_id’,’id’ ]</p>
</li>
<li><p>A FUNCTION:
The function receives a left table row and right table row during the
cartesian join.  If the function returns true for the rows considered,
the merged row is included in the result set.
EXAMPLE: function (l,r){ return l.name === r.label; }</p>
<p>Conditions are considered in the order they are presented.  Therefore the best
performance is realized when the least expensive and highest prune-rate
conditions are placed first, since if they return false Taffy skips any
further condition tests.</p>
<p>Other notes</p>
<hr>
<p>This code passes jslint with the exception of 2 warnings about
the ‘==’ and ‘!=’ lines.  We can’t do anything about that short of
deleting the lines.</p>
<p>Credits</p>
<hr>
<p>Heavily based upon the work of Ian Toltz.
Revisions to API by Michael Mikowski.
Code convention per standards in <a href="http://manning.com/mikowski">http://manning.com/mikowski</a></p>
</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> innerJoinFunction = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> fnCompareList, fnCombineRow, fnMain;

        fnCompareList = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> left_row, right_row, arg_list </span>) </span>{
          <span class="hljs-keyword">var</span> data_lt, data_rt, op_code, error;

          <span class="hljs-keyword">if</span> ( arg_list.length === <span class="hljs-number">2</span> ){
            data_lt = left_row[arg_list[<span class="hljs-number">0</span>]];
            op_code = <span class="hljs-string">'==='</span>;
            data_rt = right_row[arg_list[<span class="hljs-number">1</span>]];
          }
          <span class="hljs-keyword">else</span> {
            data_lt = left_row[arg_list[<span class="hljs-number">0</span>]];
            op_code = arg_list[<span class="hljs-number">1</span>];
            data_rt = right_row[arg_list[<span class="hljs-number">2</span>]];
          }

          <span class="hljs-comment">/*jslint eqeq : true */</span>
          <span class="hljs-keyword">switch</span> ( op_code ){
            <span class="hljs-keyword">case</span> <span class="hljs-string">'==='</span> :
              <span class="hljs-keyword">return</span> data_lt === data_rt;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'!=='</span> :
              <span class="hljs-keyword">return</span> data_lt !== data_rt;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'&lt;'</span>   :
              <span class="hljs-keyword">return</span> data_lt &lt; data_rt;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'&gt;'</span>   :
              <span class="hljs-keyword">return</span> data_lt &gt; data_rt;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'&lt;='</span>  :
              <span class="hljs-keyword">return</span> data_lt &lt;= data_rt;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'&gt;='</span>  :
              <span class="hljs-keyword">return</span> data_lt &gt;= data_rt;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'=='</span>  :
              <span class="hljs-keyword">return</span> data_lt == data_rt;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'!='</span>  :
              <span class="hljs-keyword">return</span> data_lt != data_rt;
            <span class="hljs-keyword">default</span> :
              <span class="hljs-keyword">throw</span> <span class="hljs-built_in">String</span>( op_code ) + <span class="hljs-string">' is not supported'</span>;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>‘jslint eqeq : false’  here results in
“Unreachable ‘/*jslint’ after ‘return’”.
We don’t need it though, as the rule exception
is discarded at the end of this functional scope</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        };

        fnCombineRow = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> left_row, right_row </span>) </span>{
          <span class="hljs-keyword">var</span> out_map = {}, i, prefix;

          <span class="hljs-keyword">for</span> ( i <span class="hljs-keyword">in</span> left_row ){
            <span class="hljs-keyword">if</span> ( left_row.hasOwnProperty( i ) ){
              out_map[i] = left_row[i];
            }
          }
          <span class="hljs-keyword">for</span> ( i <span class="hljs-keyword">in</span> right_row ){
            <span class="hljs-keyword">if</span> ( right_row.hasOwnProperty( i ) &amp;&amp; i !== <span class="hljs-string">'___id'</span> &amp;&amp;
              i !== <span class="hljs-string">'___s'</span> )
            {
              prefix = !TAFFY.isUndefined( out_map[i] ) ? <span class="hljs-string">'right_'</span> : <span class="hljs-string">''</span>;
              out_map[prefix + <span class="hljs-built_in">String</span>( i ) ] = right_row[i];
            }
          }
          <span class="hljs-keyword">return</span> out_map;
        };

        fnMain = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> table </span>) </span>{
          <span class="hljs-keyword">var</span>
            right_table, i,
            arg_list = <span class="hljs-built_in">arguments</span>,
            arg_length = arg_list.length,
            result_list = []
            ;

          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> table.filter !== <span class="hljs-string">'function'</span> ){
            <span class="hljs-keyword">if</span> ( table.TAFFY ){ right_table = table(); }
            <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">throw</span> <span class="hljs-string">'TAFFY DB or result not supplied'</span>;
            }
          }
          <span class="hljs-keyword">else</span> { right_table = table; }

          <span class="hljs-keyword">this</span>.context( {
            results : <span class="hljs-keyword">this</span>.getDBI().query( <span class="hljs-keyword">this</span>.context() )
          } );

          TAFFY.each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> left_row </span>) </span>{
            right_table.each( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> right_row </span>) </span>{
              <span class="hljs-keyword">var</span> arg_data, is_ok = <span class="hljs-literal">true</span>;
              CONDITION:
                <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">1</span>; i &lt; arg_length; i++ ){
                  arg_data = arg_list[i];
                  <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> arg_data === <span class="hljs-string">'function'</span> ){
                    is_ok = arg_data( left_row, right_row );
                  }
                  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> arg_data === <span class="hljs-string">'object'</span> &amp;&amp; arg_data.length ){
                    is_ok = fnCompareList( left_row, right_row, arg_data );
                  }
                  <span class="hljs-keyword">else</span> {
                    is_ok = <span class="hljs-literal">false</span>;
                  }

                  <span class="hljs-keyword">if</span> ( !is_ok ){ <span class="hljs-keyword">break</span> CONDITION; } <span class="hljs-comment">// short circuit</span>
                }

              <span class="hljs-keyword">if</span> ( is_ok ){
                result_list.push( fnCombineRow( left_row, right_row ) );
              }
            } );
          } );
          <span class="hljs-keyword">return</span> TAFFY( result_list )();
        };

        <span class="hljs-keyword">return</span> fnMain;
      }());

      API.extend( <span class="hljs-string">'join'</span>, innerJoinFunction );
    }());

    API.extend( <span class="hljs-string">'max'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> c </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: column to find max</li>
<li>Returns: the highest value</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> highest = <span class="hljs-literal">null</span>;
      run.call( <span class="hljs-keyword">this</span> );
      each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
        <span class="hljs-keyword">if</span> ( highest === <span class="hljs-literal">null</span> || r[c] &gt; highest ){
          highest = r[c];
        }
      });
      <span class="hljs-keyword">return</span> highest;
    });

    API.extend( <span class="hljs-string">'select'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: columns to select values into an array</li>
<li>Returns: array of values</li>
<li>Note if more than one column is given an array of arrays is returned</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-keyword">var</span> ra = [], args = <span class="hljs-built_in">arguments</span>;
      run.call( <span class="hljs-keyword">this</span> );
      <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">1</span> ){

        each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{

          ra.push( r[args[<span class="hljs-number">0</span>]] );
        });
      }
      <span class="hljs-keyword">else</span> {
        each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
          <span class="hljs-keyword">var</span> row = [];
          each( args, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> c </span>) </span>{
            row.push( r[c] );
          });
          ra.push( row );
        });
      }
      <span class="hljs-keyword">return</span> ra;
    });
    API.extend( <span class="hljs-string">'distinct'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: columns to select unique alues into an array</li>
<li>Returns: array of values</li>
<li>Note if more than one column is given an array of arrays is returned</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> ra = [], args = <span class="hljs-built_in">arguments</span>;
      run.call( <span class="hljs-keyword">this</span> );
      <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">1</span> ){

        each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
          <span class="hljs-keyword">var</span> v = r[args[<span class="hljs-number">0</span>]], dup = <span class="hljs-literal">false</span>;
          each( ra, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> d </span>) </span>{
            <span class="hljs-keyword">if</span> ( v === d ){
              dup = <span class="hljs-literal">true</span>;
              <span class="hljs-keyword">return</span> TAFFY.EXIT;
            }
          });
          <span class="hljs-keyword">if</span> ( !dup ){
            ra.push( v );
          }
        });
      }
      <span class="hljs-keyword">else</span> {
        each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
          <span class="hljs-keyword">var</span> row = [], dup = <span class="hljs-literal">false</span>;
          each( args, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> c </span>) </span>{
            row.push( r[c] );
          });
          each( ra, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> d </span>) </span>{
            <span class="hljs-keyword">var</span> ldup = <span class="hljs-literal">true</span>;
            each( args, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> c, i </span>) </span>{
              <span class="hljs-keyword">if</span> ( row[i] !== d[i] ){
                ldup = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> TAFFY.EXIT;
              }
            });
            <span class="hljs-keyword">if</span> ( ldup ){
              dup = <span class="hljs-literal">true</span>;
              <span class="hljs-keyword">return</span> TAFFY.EXIT;
            }
          });
          <span class="hljs-keyword">if</span> ( !dup ){
            ra.push( row );
          }
        });
      }
      <span class="hljs-keyword">return</span> ra;
    });
    API.extend( <span class="hljs-string">'supplant'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> template, returnarray </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: a string template formated with key to be replaced with values from the rows, flag to determine if we want array of strings</li>
<li>Returns: array of values or a string</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> ra = [];
      run.call( <span class="hljs-keyword">this</span> );
      each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>TODO: The curly braces used to be unescaped</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ra.push( template.replace( <span class="hljs-regexp">/\{([^\{\}]*)\}/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> a, b </span>) </span>{
          <span class="hljs-keyword">var</span> v = r[b];
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'number'</span> ? v : a;
        } ) );
      });
      <span class="hljs-keyword">return</span> (!returnarray) ? ra.join( <span class="hljs-string">""</span> ) : ra;
    });


    API.extend( <span class="hljs-string">'each'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> m </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: a function</li>
<li>Purpose: loops over every matching record and applies the function</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      run.call( <span class="hljs-keyword">this</span> );
      each( <span class="hljs-keyword">this</span>.context().results, m );
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    });
    API.extend( <span class="hljs-string">'map'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> m </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: a function</li>
<li>Purpose: loops over every matching record and applies the function, returing the results in an array</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> ra = [];
      run.call( <span class="hljs-keyword">this</span> );
      each( <span class="hljs-keyword">this</span>.context().results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
        ra.push( m( r ) );
      });
      <span class="hljs-keyword">return</span> ra;
    });



    T = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> d </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>T is the main TAFFY object</li>
<li>Takes: an array of objects or JSON</li>
<li>Returns a new TAFFYDB</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> TOb = [],
        ID = {},
        RC = <span class="hljs-number">1</span>,
        settings = {
          template          : <span class="hljs-literal">false</span>,
          onInsert          : <span class="hljs-literal">false</span>,
          onUpdate          : <span class="hljs-literal">false</span>,
          onRemove          : <span class="hljs-literal">false</span>,
          onDBChange        : <span class="hljs-literal">false</span>,
          storageName       : <span class="hljs-literal">false</span>,
          forcePropertyCase : <span class="hljs-literal">null</span>,
          cacheSize         : <span class="hljs-number">100</span>,
          name              : <span class="hljs-string">''</span>
        },
        dm = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
        CacheCount = <span class="hljs-number">0</span>,
        CacheClear = <span class="hljs-number">0</span>,
        Cache = {},
        DBI, runIndexes, root
        ;</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>TOb = this database</li>
<li>ID = collection of the record IDs and locations within the DB, used for fast lookups</li>
<li>RC = record counter, used for creating IDs</li>
<li>settings.template = the template to merge all new records with</li>
<li>settings.onInsert = event given a copy of the newly inserted record</li>
<li>settings.onUpdate = event given the original record, the changes, and the new record</li>
<li>settings.onRemove = event given the removed record</li>
<li>settings.forcePropertyCase = on insert force the proprty case to be lower or upper. default lower, null/undefined will leave case as is</li>
<li>dm = the modify date of the database, used for query caching</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>

      runIndexes = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> indexes </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: a collection of indexes</li>
<li>Returns: collection with records matching indexed filters</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">var</span> records = [], UniqueEnforce = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> ( indexes.length === <span class="hljs-number">0</span> ){
          <span class="hljs-keyword">return</span> TOb;
        }

        each( indexes, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Check to see if record ID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( T.isString( f ) &amp;&amp; <span class="hljs-regexp">/[t][0-9]*[r][0-9]*/i</span>.test( f ) &amp;&amp;
            TOb[ID[f]] )
          {
            records.push( TOb[ID[f]] );
            UniqueEnforce = <span class="hljs-literal">true</span>;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Check to see if record</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( T.isObject( f ) &amp;&amp; f.___id &amp;&amp; f.___s &amp;&amp;
            TOb[ID[f.___id]] )
          {
            records.push( TOb[ID[f.___id]] );
            UniqueEnforce = <span class="hljs-literal">true</span>;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Check to see if array of indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( T.isArray( f ) ){
            each( f, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
              each( runIndexes( r ), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> rr </span>) </span>{
                records.push( rr );
              });

            });
          }
        });
        <span class="hljs-keyword">if</span> ( UniqueEnforce &amp;&amp; records.length &gt; <span class="hljs-number">1</span> ){
          records = [];
        }

        <span class="hljs-keyword">return</span> records;
      };

      DBI = {</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>The DBI is the internal DataBase Interface that interacts with the data</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>        dm           : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> nd </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: an optional new modify date</li>
<li>Purpose: used to get and set the DB modify date</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( nd ){
            dm = nd;
            Cache = {};
            CacheCount = <span class="hljs-number">0</span>;
            CacheClear = <span class="hljs-number">0</span>;
          }
          <span class="hljs-keyword">if</span> ( settings.onDBChange ){
            setTimeout( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
              settings.onDBChange.call( TOb );
            }, <span class="hljs-number">0</span> );
          }
          <span class="hljs-keyword">if</span> ( settings.storageName ){
            setTimeout( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
              localStorage.setItem( <span class="hljs-string">'taffy_'</span> + settings.storageName,
                <span class="hljs-built_in">JSON</span>.stringify( TOb ) );
            });
          }
          <span class="hljs-keyword">return</span> dm;
        },
        insert       : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> i, runEvent </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: a new record to insert</li>
<li>Purpose: merge the object with the template, add an ID, insert into DB, call insert event</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> columns = [],
            records   = [],
            input     = protectJSON( i )
            ;
          each( input, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, i </span>) </span>{
            <span class="hljs-keyword">var</span> nv, o;
            <span class="hljs-keyword">if</span> ( T.isArray( v ) &amp;&amp; i === <span class="hljs-number">0</span> ){
              each( v, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> av </span>) </span>{

                columns.push( (settings.forcePropertyCase === <span class="hljs-string">'lower'</span>)
                  ? av.toLowerCase()
                    : (settings.forcePropertyCase === <span class="hljs-string">'upper'</span>)
                  ? av.toUpperCase() : av );
              });
              <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( T.isArray( v ) ){
              nv = {};
              each( v, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> av, ai </span>) </span>{
                nv[columns[ai]] = av;
              });
              v = nv;

            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( T.isObject( v ) &amp;&amp; settings.forcePropertyCase ){
              o = {};

              eachin( v, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> av, ai </span>) </span>{
                o[(settings.forcePropertyCase === <span class="hljs-string">'lower'</span>) ? ai.toLowerCase()
                  : (settings.forcePropertyCase === <span class="hljs-string">'upper'</span>)
                  ? ai.toUpperCase() : ai] = v[ai];
              });
              v = o;
            }

            RC++;
            v.___id = <span class="hljs-string">'T'</span> + <span class="hljs-built_in">String</span>( idpad + TC ).slice( -<span class="hljs-number">6</span> ) + <span class="hljs-string">'R'</span> +
              <span class="hljs-built_in">String</span>( idpad + RC ).slice( -<span class="hljs-number">6</span> );
            v.___s = <span class="hljs-literal">true</span>;
            records.push( v.___id );
            <span class="hljs-keyword">if</span> ( settings.template ){
              v = T.mergeObj( settings.template, v );
            }
            TOb.push( v );

            ID[v.___id] = TOb.length - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> ( settings.onInsert &amp;&amp;
              (runEvent || TAFFY.isUndefined( runEvent )) )
            {
              settings.onInsert.call( v );
            }
            DBI.dm( <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() );
          });
          <span class="hljs-keyword">return</span> root( records );
        },
        sort         : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> o </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Purpose: Change the sort order of the DB itself and reset the ID bucket</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>          TOb = orderByCol( TOb, o.split( <span class="hljs-string">','</span> ) );
          ID = {};
          each( TOb, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r, i </span>) </span>{
            ID[r.___id] = i;
          });
          DBI.dm( <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() );
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        },
        update       : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> id, changes, runEvent </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: the ID of record being changed and the changes</li>
<li>Purpose: Update a record and change some or all values, call the on update method</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>
          <span class="hljs-keyword">var</span> nc = {}, or, nr, tc, hasChange;
          <span class="hljs-keyword">if</span> ( settings.forcePropertyCase ){
            eachin( changes, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, p </span>) </span>{
              nc[(settings.forcePropertyCase === <span class="hljs-string">'lower'</span>) ? p.toLowerCase()
                : (settings.forcePropertyCase === <span class="hljs-string">'upper'</span>) ? p.toUpperCase()
                : p] = v;
            });
            changes = nc;
          }

          or = TOb[ID[id]];
          nr = T.mergeObj( or, changes );

          tc = {};
          hasChange = <span class="hljs-literal">false</span>;
          eachin( nr, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, i </span>) </span>{
            <span class="hljs-keyword">if</span> ( TAFFY.isUndefined( or[i] ) || or[i] !== v ){
              tc[i] = v;
              hasChange = <span class="hljs-literal">true</span>;
            }
          });
          <span class="hljs-keyword">if</span> ( hasChange ){
            <span class="hljs-keyword">if</span> ( settings.onUpdate &amp;&amp;
              (runEvent || TAFFY.isUndefined( runEvent )) )
            {
              settings.onUpdate.call( nr, TOb[ID[id]], tc );
            }
            TOb[ID[id]] = nr;
            DBI.dm( <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() );
          }
        },
        remove       : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> id </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: the ID of record to be removed</li>
<li>Purpose: remove a record, changes its ___s value to false</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>          TOb[ID[id]].___s = <span class="hljs-literal">false</span>;
        },
        removeCommit : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> runEvent </span>) </span>{
          <span class="hljs-keyword">var</span> x;</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li></li>
<li>Purpose: loop over all records and remove records with ___s = false, call onRemove event, clear ID</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">for</span> ( x = TOb.length - <span class="hljs-number">1</span>; x &gt; -<span class="hljs-number">1</span>; x-- ){

            <span class="hljs-keyword">if</span> ( !TOb[x].___s ){
              <span class="hljs-keyword">if</span> ( settings.onRemove &amp;&amp;
                (runEvent || TAFFY.isUndefined( runEvent )) )
              {
                settings.onRemove.call( TOb[x] );
              }
              ID[TOb[x].___id] = <span class="hljs-literal">undefined</span>;
              TOb.splice( x, <span class="hljs-number">1</span> );
            }
          }
          ID = {};
          each( TOb, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r, i </span>) </span>{
            ID[r.___id] = i;
          });
          DBI.dm( <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() );
        },
        query : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> context </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Takes: the context object for a query and either returns a cache result or a new query result</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> returnq, cid, results, indexed, limitq, ni;

          <span class="hljs-keyword">if</span> ( settings.cacheSize ) {
            cid = <span class="hljs-string">''</span>;
            each( context.filterRaw, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
              <span class="hljs-keyword">if</span> ( T.isFunction( r ) ){
                cid = <span class="hljs-string">'nocache'</span>;
                <span class="hljs-keyword">return</span> TAFFY.EXIT;
              }
            });
            <span class="hljs-keyword">if</span> ( cid === <span class="hljs-string">''</span> ){
              cid = makeCid( T.mergeObj( context,
                {q : <span class="hljs-literal">false</span>, run : <span class="hljs-literal">false</span>, sort : <span class="hljs-literal">false</span>} ) );
            }
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Run a new query if there are no results or the run date has been cleared</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( !context.results || !context.run ||
            (context.run &amp;&amp; DBI.dm() &gt; context.run) )
          {
            results = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>check Cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">if</span> ( settings.cacheSize &amp;&amp; Cache[cid] ){

              Cache[cid].i = CacheCount++;
              <span class="hljs-keyword">return</span> Cache[cid].results;
            }
            <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>if no filter, return DB</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> ( context.q.length === <span class="hljs-number">0</span> &amp;&amp; context.index.length === <span class="hljs-number">0</span> ){
                each( TOb, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{
                  results.push( r );
                });
                returnq = results;
              }
              <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>use indexes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                indexed = runIndexes( context.index );</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>run filters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                each( indexed, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Run filter to see if record matches query</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  <span class="hljs-keyword">if</span> ( context.q.length === <span class="hljs-number">0</span> || runFilters( r, context.q ) ){
                    results.push( r );
                  }
                });

                returnq = results;
              }
            }


          }
          <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>If query exists and run has not been cleared return the cache results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            returnq = context.results;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>If a custom order array exists and the run has been clear or the sort has been cleared</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( context.order.length &gt; <span class="hljs-number">0</span> &amp;&amp; (!context.run || !context.sort) ){</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>order the results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            returnq = orderByCol( returnq, context.order );
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>If a limit on the number of results exists and it is less than the returned results, limit results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( returnq.length &amp;&amp;
            ((context.limit &amp;&amp; context.limit &lt; returnq.length) ||
              context.start)
          ) {
            limitq = [];
            each( returnq, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r, i </span>) </span>{
              <span class="hljs-keyword">if</span> ( !context.start ||
                (context.start &amp;&amp; (i + <span class="hljs-number">1</span>) &gt;= context.start) )
              {
                <span class="hljs-keyword">if</span> ( context.limit ){
                  ni = (context.start) ? (i + <span class="hljs-number">1</span>) - context.start : i;
                  <span class="hljs-keyword">if</span> ( ni &lt; context.limit ){
                    limitq.push( r );
                  }
                  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( ni &gt; context.limit ){
                    <span class="hljs-keyword">return</span> TAFFY.EXIT;
                  }
                }
                <span class="hljs-keyword">else</span> {
                  limitq.push( r );
                }
              }
            });
            returnq = limitq;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>update cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> ( settings.cacheSize &amp;&amp; cid !== <span class="hljs-string">'nocache'</span> ){
            CacheClear++;

            setTimeout( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">var</span> bCounter, nc;
              <span class="hljs-keyword">if</span> ( CacheClear &gt;= settings.cacheSize * <span class="hljs-number">2</span> ){
                CacheClear = <span class="hljs-number">0</span>;
                bCounter = CacheCount - settings.cacheSize;
                nc = {};
                eachin( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> r, k </span>) </span>{
                  <span class="hljs-keyword">if</span> ( r.i &gt;= bCounter ){
                    nc[k] = r;
                  }
                });
                Cache = nc;
              }
            }, <span class="hljs-number">0</span> );

            Cache[cid] = { i : CacheCount++, results : returnq };
          }
          <span class="hljs-keyword">return</span> returnq;
        }
      };


      root = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> iAPI, context;</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>The root function that gets returned when a new DB is created</li>
<li>Takes: unlimited filter arguments and creates filters to be run when a query is called</li>
</ul>
<hr>
<hr>
<p>*</p>
<ul>
<li>iAPI is the the method collection valiable when a query has been started by calling dbname</li>
<li>Certain methods are or are not avaliable once you have started a query such as insert – you can only insert into root</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>        iAPI = TAFFY.mergeObj( TAFFY.mergeObj( API, { insert : <span class="hljs-literal">undefined</span> } ),
          { getDBI  : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> DBI; },
            getroot : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> c </span>) </span>{ <span class="hljs-keyword">return</span> root.call( c ); },
          context : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> n </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>The context contains all the information to manage a query including filters, limits, and sorts</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( n ){
              context = TAFFY.mergeObj( context,
                n.hasOwnProperty(<span class="hljs-string">'results'</span>)
                  ? TAFFY.mergeObj( n, { run : <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(), sort: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() })
                  : n
              );
            }
            <span class="hljs-keyword">return</span> context;
          },
          extend  : <span class="hljs-literal">undefined</span>
        });

        context = (<span class="hljs-keyword">this</span> &amp;&amp; <span class="hljs-keyword">this</span>.q) ? <span class="hljs-keyword">this</span> : {
          limit     : <span class="hljs-literal">false</span>,
          start     : <span class="hljs-literal">false</span>,
          q         : [],
          filterRaw : [],
          index     : [],
          order     : [],
          results   : <span class="hljs-literal">false</span>,
          run       : <span class="hljs-literal">null</span>,
          sort      : <span class="hljs-literal">null</span>,
          settings  : settings
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Call the query method to setup a new query</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>        each( <span class="hljs-built_in">arguments</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> f </span>) </span>{

          <span class="hljs-keyword">if</span> ( isIndexable( f ) ){
            context.index.push( f );
          }
          <span class="hljs-keyword">else</span> {
            context.q.push( returnFilter( f ) );
          }
          context.filterRaw.push( f );
        });


        <span class="hljs-keyword">return</span> iAPI;
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>If new records have been passed on creation of the DB either as JSON or as an array/object, insert them</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      TC++;
      <span class="hljs-keyword">if</span> ( d ){
        DBI.insert( d );
      }


      root.insert = DBI.insert;

      root.merge = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> i, key, runEvent </span>) </span>{
        <span class="hljs-keyword">var</span>
          search      = {},
          finalSearch = [],
          obj         = {}
          ;

        runEvent    = runEvent || <span class="hljs-literal">false</span>;
        key         = key      || <span class="hljs-string">'id'</span>;

        each( i, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> o </span>) </span>{
          <span class="hljs-keyword">var</span> existingObject;
          search[key] = o[key];
          finalSearch.push( o[key] );
          existingObject = root( search ).first();
          <span class="hljs-keyword">if</span> ( existingObject ){
            DBI.update( existingObject.___id, o, runEvent );
          }
          <span class="hljs-keyword">else</span> {
            DBI.insert( o, runEvent );
          }
        });

        obj[key] = finalSearch;
        <span class="hljs-keyword">return</span> root( obj );
      };

      root.TAFFY = <span class="hljs-literal">true</span>;
      root.sort = DBI.sort;</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>These are the methods that can be accessed on off the root DB function. Example dbname.insert;</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      root.settings = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> n </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Getting and setting for this DB’s settings/events</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( n ){
          settings = TAFFY.mergeObj( settings, n );
          <span class="hljs-keyword">if</span> ( n.template ){

            root().update( n.template );
          }
        }
        <span class="hljs-keyword">return</span> settings;
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>These are the methods that can be accessed on off the root DB function. Example dbname.insert;</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      root.store = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> n </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Setup localstorage for this DB on a given name</li>
<li>Pull data into the DB as needed</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> r = <span class="hljs-literal">false</span>, i;
        <span class="hljs-keyword">if</span> ( localStorage ){
          <span class="hljs-keyword">if</span> ( n ){
            i = localStorage.getItem( <span class="hljs-string">'taffy_'</span> + n );
            <span class="hljs-keyword">if</span> ( i &amp;&amp; i.length &gt; <span class="hljs-number">0</span> ){
              root.insert( i );
              r = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">if</span> ( TOb.length &gt; <span class="hljs-number">0</span> ){
              setTimeout( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                localStorage.setItem( <span class="hljs-string">'taffy_'</span> + settings.storageName,
                  <span class="hljs-built_in">JSON</span>.stringify( TOb ) );
              });
            }
          }
          root.settings( {storageName : n} );
        }
        <span class="hljs-keyword">return</span> root;
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Return root on DB creation and start having fun</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> root;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Sets the global TAFFY object</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    TAFFY = T;</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public each method
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    T.each = each;</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public eachin method
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    T.eachin = eachin;</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public extend method</li>
<li>Add a custom method to the API
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    T.extend = API.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Creates TAFFY.EXIT value that can be returned to stop an each loop
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    TAFFY.EXIT = <span class="hljs-string">'TAFFYEXIT'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public utility mergeObj method</li>
<li>Return a new object where items from obj2</li>
<li>have replaced or been added to the items in</li>
<li>obj1</li>
<li>Purpose: Used to combine objs
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    TAFFY.mergeObj = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> ob1, ob2 </span>) </span>{
      <span class="hljs-keyword">var</span> c = {};
      eachin( ob1, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, n </span>) </span>{ c[n] = ob1[n]; });
      eachin( ob2, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, n </span>) </span>{ c[n] = ob2[n]; });
      <span class="hljs-keyword">return</span> c;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public utility has method</li>
<li>Returns true if a complex object, array</li>
<li>or taffy collection contains the material</li>
<li>provided in the second argument</li>
<li>Purpose: Used to comare objects
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    TAFFY.has = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> var1, var2 </span>) </span>{

      <span class="hljs-keyword">var</span> re = <span class="hljs-literal">false</span>, n;

      <span class="hljs-keyword">if</span> ( (var1.TAFFY) ){
        re = var1( var2 );
        <span class="hljs-keyword">if</span> ( re.length &gt; <span class="hljs-number">0</span> ){
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
      }
      <span class="hljs-keyword">else</span> {

        <span class="hljs-keyword">switch</span> ( T.typeOf( var1 ) ){
          <span class="hljs-keyword">case</span> <span class="hljs-string">'object'</span>:
            <span class="hljs-keyword">if</span> ( T.isObject( var2 ) ){
              eachin( var2, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, n </span>) </span>{
                <span class="hljs-keyword">if</span> ( re === <span class="hljs-literal">true</span> &amp;&amp; !T.isUndefined( var1[n] ) &amp;&amp;
                  var1.hasOwnProperty( n ) )
                {
                  re = T.has( var1[n], var2[n] );
                }
                <span class="hljs-keyword">else</span> {
                  re = <span class="hljs-literal">false</span>;
                  <span class="hljs-keyword">return</span> TAFFY.EXIT;
                }
              });
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( T.isArray( var2 ) ){
              each( var2, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, n </span>) </span>{
                re = T.has( var1, var2[n] );
                <span class="hljs-keyword">if</span> ( re ){
                  <span class="hljs-keyword">return</span> TAFFY.EXIT;
                }
              });
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( T.isString( var2 ) ){
              <span class="hljs-keyword">if</span> ( !TAFFY.isUndefined( var1[var2] ) ){
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
              }
              <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
              }
            }
            <span class="hljs-keyword">return</span> re;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'array'</span>:
            <span class="hljs-keyword">if</span> ( T.isObject( var2 ) ){
              each( var1, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, i </span>) </span>{
                re = T.has( var1[i], var2 );
                <span class="hljs-keyword">if</span> ( re === <span class="hljs-literal">true</span> ){
                  <span class="hljs-keyword">return</span> TAFFY.EXIT;
                }
              });
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( T.isArray( var2 ) ){
              each( var2, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v2, i2 </span>) </span>{
                each( var1, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v1, i1 </span>) </span>{
                  re = T.has( var1[i1], var2[i2] );
                  <span class="hljs-keyword">if</span> ( re === <span class="hljs-literal">true</span> ){
                    <span class="hljs-keyword">return</span> TAFFY.EXIT;
                  }
                });
                <span class="hljs-keyword">if</span> ( re === <span class="hljs-literal">true</span> ){
                  <span class="hljs-keyword">return</span> TAFFY.EXIT;
                }
              });
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( T.isString( var2 ) || T.isNumber( var2 ) ){
             re = <span class="hljs-literal">false</span>;
              <span class="hljs-keyword">for</span> ( n = <span class="hljs-number">0</span>; n &lt; var1.length; n++ ){
                re = T.has( var1[n], var2 );
                <span class="hljs-keyword">if</span> ( re ){
                  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
              }
            }
            <span class="hljs-keyword">return</span> re;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'string'</span>:
            <span class="hljs-keyword">if</span> ( T.isString( var2 ) &amp;&amp; var2 === var1 ){
              <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">if</span> ( T.typeOf( var1 ) === T.typeOf( var2 ) &amp;&amp; var1 === var2 ){
              <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">break</span>;
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public utility hasAll method</li>
<li>Returns true if a complex object, array</li>
<li>or taffy collection contains the material</li>
<li>provided in the call - for arrays it must</li>
<li>contain all the material in each array item</li>
<li>Purpose: Used to comare objects
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    TAFFY.hasAll = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> var1, var2 </span>) </span>{

      <span class="hljs-keyword">var</span> T = TAFFY, ar;
      <span class="hljs-keyword">if</span> ( T.isArray( var2 ) ){
        ar = <span class="hljs-literal">true</span>;
        each( var2, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v </span>) </span>{
          ar = T.has( var1, v );
          <span class="hljs-keyword">if</span> ( ar === <span class="hljs-literal">false</span> ){
            <span class="hljs-keyword">return</span> TAFFY.EXIT;
          }
        });
        <span class="hljs-keyword">return</span> ar;
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> T.has( var1, var2 );
      }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>typeOf Fixed in JavaScript as public utility
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    TAFFY.typeOf = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v </span>) </span>{
      <span class="hljs-keyword">var</span> s = <span class="hljs-keyword">typeof</span> v;
      <span class="hljs-keyword">if</span> ( s === <span class="hljs-string">'object'</span> ){
        <span class="hljs-keyword">if</span> ( v ){
          <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span> v.length === <span class="hljs-string">'number'</span> &amp;&amp;
            !(v.propertyIsEnumerable( <span class="hljs-string">'length'</span> )) )
          {
            s = <span class="hljs-string">'array'</span>;
          }
        }
        <span class="hljs-keyword">else</span> {
          s = <span class="hljs-string">'null'</span>;
        }
      }
      <span class="hljs-keyword">return</span> s;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public utility getObjectKeys method</li>
<li>Returns an array of an objects keys</li>
<li>Purpose: Used to get the keys for an object
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    TAFFY.getObjectKeys = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> ob </span>) </span>{
      <span class="hljs-keyword">var</span> kA = [];
      eachin( ob, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> n, h </span>) </span>{
        kA.push( h );
      });
      kA.sort();
      <span class="hljs-keyword">return</span> kA;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public utility isSameArray</li>
<li>Returns an array of an objects keys</li>
<li>Purpose: Used to get the keys for an object
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    TAFFY.isSameArray = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> ar1, ar2 </span>) </span>{
      <span class="hljs-keyword">return</span> (TAFFY.isArray( ar1 ) &amp;&amp; TAFFY.isArray( ar2 ) &amp;&amp;
        ar1.join( <span class="hljs-string">','</span> ) === ar2.join( <span class="hljs-string">','</span> )) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public utility isSameObject method</li>
<li>Returns true if objects contain the same</li>
<li>material or false if they do not</li>
<li>Purpose: Used to comare objects
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>    TAFFY.isSameObject = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> ob1, ob2 </span>) </span>{
      <span class="hljs-keyword">var</span> T = TAFFY, rv = <span class="hljs-literal">true</span>;

      <span class="hljs-keyword">if</span> ( T.isObject( ob1 ) &amp;&amp; T.isObject( ob2 ) ){
        <span class="hljs-keyword">if</span> ( T.isSameArray( T.getObjectKeys( ob1 ),
          T.getObjectKeys( ob2 ) ) )
        {
          eachin( ob1, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> v, n </span>) </span>{
            <span class="hljs-keyword">if</span> ( ! ( (T.isObject( ob1[n] ) &amp;&amp; T.isObject( ob2[n] ) &amp;&amp;
              T.isSameObject( ob1[n], ob2[n] )) ||
              (T.isArray( ob1[n] ) &amp;&amp; T.isArray( ob2[n] ) &amp;&amp;
                T.isSameArray( ob1[n], ob2[n] )) || (ob1[n] === ob2[n]) )
            ) {
              rv = <span class="hljs-literal">false</span>;
              <span class="hljs-keyword">return</span> TAFFY.EXIT;
            }
          });
        }
        <span class="hljs-keyword">else</span> {
          rv = <span class="hljs-literal">false</span>;
        }
      }
      <span class="hljs-keyword">else</span> {
        rv = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">return</span> rv;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <hr>
<p>*</p>
<ul>
<li>Create public utility is[DataType] methods</li>
<li>Return true if obj is datatype, false otherwise</li>
<li>Purpose: Used to determine if arguments are of certain data type
*</li>
<li>mmikowski 2012-08-06 refactored to make much less “magical”:</li>
<li>fewer closures and passes jslint
*</li>
</ul>
<hr>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    typeList = [
      <span class="hljs-string">'String'</span>,  <span class="hljs-string">'Number'</span>, <span class="hljs-string">'Object'</span>,   <span class="hljs-string">'Array'</span>,
      <span class="hljs-string">'Boolean'</span>, <span class="hljs-string">'Null'</span>,   <span class="hljs-string">'Function'</span>, <span class="hljs-string">'Undefined'</span>
    ];
  
    makeTest = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> thisKey </span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> data </span>) </span>{
        <span class="hljs-keyword">return</span> TAFFY.typeOf( data ) === thisKey.toLowerCase() ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
      };
    };
  
    <span class="hljs-keyword">for</span> ( idx = <span class="hljs-number">0</span>; idx &lt; typeList.length; idx++ ){
      typeKey = typeList[idx];
      TAFFY[<span class="hljs-string">'is'</span> + typeKey] = makeTest( typeKey );
    }
  }
}());

<span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span>(exports) === <span class="hljs-string">'object'</span> ){
  exports.taffy = TAFFY;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
