<!DOCTYPE html>

<html>
<head>
  <title>generator.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>generator.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * This is the documentation generator.
 * Unfortunately, there is now way we can make it streamy - doc generation is entirely
 * delegated to the opaqure publish method of each template...
 * Also, jsdoc structure requires us to:
 * - manipulate global variables
 * - copy over templates into node_modules
 * ... and there is little to be done - apart maybe changing jsdoc organization radically?
 * :(
 */</span>

(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
<span class="hljs-pi">  'use strict'</span>;

  <span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
  <span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
  <span class="hljs-keyword">var</span> wrench = <span class="hljs-built_in">require</span>(<span class="hljs-string">'wrench'</span>);
  <span class="hljs-keyword">var</span> taffy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'taffydb'</span>).taffy;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Unfortunately, jsdoc rely on globals for the templating output part</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> env = global.env = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Some templates may need these and crash for the lack of it :/</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> jsdocPkg = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsdoc/package.json'</span>);
    env.version = {
      number: jsdocPkg.version,
      revision: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>( <span class="hljs-built_in">parseInt</span>(jsdocPkg.revision, <span class="hljs-number">10</span>) ).toUTCString()
    };
  }());</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Init other global objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  env.opts = env.opts || {};
  env.conf = env.conf || {};
  env.conf.templates = env.conf.templates || {};
  env.conf.templates[<span class="hljs-string">'default'</span>] = env.conf.templates[<span class="hljs-string">'default'</span>] || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>We need the location of jsboot module because we MUST copy custom templates there :(((
Also, part of jsdoc won’t even boot without this :(</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> jsdocRoot = env.dirname = path.dirname(<span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'jsdoc/cli'</span>));

  <span class="hljs-keyword">var</span> Generator = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">destination, template, options</span>)</span>{
    options = options || {};

    env.conf.tags = {
      allowUnknownTags: <span class="hljs-literal">true</span>
    };

    env.opts[<span class="hljs-string">'private'</span>] = !!options.showPrivate;

    env.conf.templates.monospaceLinks = !!options.monospaceLinks;
    env.conf.templates.cleverLinks = !!options.cleverLinks;
    env.conf.templates[<span class="hljs-string">'default'</span>].outputSourceFiles = (<span class="hljs-string">'outputSourceFiles'</span> <span class="hljs-keyword">in</span> options) ? options.outputSourceFiles : <span class="hljs-literal">true</span>;

    template = template || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Overload conf object with optional template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">Object</span>.keys(template).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key</span>)</span>{
      <span class="hljs-keyword">if</span>(key != <span class="hljs-string">'path'</span>)
        env.conf.templates[key] = template[key];
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Magic do</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(template.path == <span class="hljs-string">'ink-docstrap'</span>){
      template.path = path.join(__dirname, <span class="hljs-string">'..'</span>, <span class="hljs-string">'node_modules'</span>, <span class="hljs-string">'ink-docstrap'</span>, <span class="hljs-string">'template'</span>);
    }

    <span class="hljs-keyword">if</span>(template.path &amp;&amp; fs.existsSync(template.path)){
      env.opts.template = path.join(jsdocRoot, path.basename(path.dirname(path.dirname(template.path))) + <span class="hljs-string">'-'</span> + path.basename(path.dirname(template.path)) + <span class="hljs-string">'-godamnawful'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>XXX this is god f damn awful jsdoc!!!
Templates SHOULD instead require a separate jsdoc-template module…
No one freakin uses rhino…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      wrench.copyDirSyncRecursive(template.path, env.opts.template, {
        forceDelete: <span class="hljs-literal">true</span>
      });
    }<span class="hljs-keyword">else</span>
      env.opts.template = path.join(jsdocRoot, <span class="hljs-string">'templates/default'</span>);

    env.opts.destination = destination || <span class="hljs-string">'./doc/jsdoc'</span>;

    <span class="hljs-keyword">var</span> tpl;
    <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>XXX this is a terrible hack, to fix #1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">var</span> offendingTpl = <span class="hljs-built_in">require</span>.resolve(env.opts.template + <span class="hljs-string">'/publish'</span>);
        <span class="hljs-keyword">if</span>(offendingTpl <span class="hljs-keyword">in</span> <span class="hljs-built_in">require</span>.cache)
          <span class="hljs-keyword">delete</span> <span class="hljs-built_in">require</span>.cache[offendingTpl];
        <span class="hljs-keyword">var</span> offending = <span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">'jsdoc/lib/jsdoc/util/templateHelper'</span>);
        <span class="hljs-keyword">if</span>(offending <span class="hljs-keyword">in</span> <span class="hljs-built_in">require</span>.cache)
          <span class="hljs-keyword">delete</span> <span class="hljs-built_in">require</span>.cache[offending];
      }());

      tpl = <span class="hljs-built_in">require</span>(env.opts.template + <span class="hljs-string">'/publish'</span>);
    }<span class="hljs-keyword">catch</span>(e){
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Unable to load template: '</span> + e.message || e);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>templates should include a publish.js file that exports a “publish” function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!tpl.publish || <span class="hljs-keyword">typeof</span> tpl.publish !== <span class="hljs-string">'function'</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(env.opts.template + <span class="hljs-string">' does not export a "publish" function. Global '</span> +
            <span class="hljs-string">'"publish" functions are no longer supported.'</span>);

    <span class="hljs-keyword">this</span>.render = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">vinyl</span>)</span>{
      env.opts.readme = vinyl.readme;
      tpl.publish(
          taffy(vinyl.contents.toString(<span class="hljs-string">'utf8'</span>)),
          env.opts,
          {children: []}
      );

      <span class="hljs-keyword">return</span> {};
    };
  };

  <span class="hljs-built_in">module</span>.exports = Generator;

}());</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
