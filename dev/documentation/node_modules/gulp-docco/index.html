<!DOCTYPE html>

<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
<span class="hljs-pi">  'use strict'</span>;

  <span class="hljs-keyword">var</span> through2 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'through2'</span>),
      path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>),
      gutil = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-util'</span>);

  <span class="hljs-keyword">var</span> PluginError = gutil.PluginError;

  <span class="hljs-keyword">var</span> helpers = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/helpers.js'</span>);
  <span class="hljs-keyword">var</span> Backend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/backend.js'</span>);

  <span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);
  <span class="hljs-keyword">var</span> vfs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vinyl-fs'</span>);

  <span class="hljs-comment">/**
   * That's the plugin parser
   */</span>
  <span class="hljs-keyword">var</span> streamParser = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">config</span>) </span>{
    config = config || {};
    config = helpers.configure(config);

    <span class="hljs-keyword">var</span> wp = <span class="hljs-keyword">new</span> Backend(config);

    <span class="hljs-keyword">var</span> templateReady;

    <span class="hljs-keyword">var</span> parse = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file, enc, next</span>)</span>{
      <span class="hljs-keyword">if</span> (file.isNull()) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// ignore</span>
      <span class="hljs-keyword">if</span> (file.isStream()) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> PluginError(<span class="hljs-string">'gulp-docco'</span>,  <span class="hljs-string">'Streaming not supported'</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Ignore unsupported files altogether</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> lang = helpers.isSupported(file.path, config);
      <span class="hljs-keyword">if</span> (!lang) {
        next();
        <span class="hljs-keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Got template? process file and go on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(templateReady){
        wp.process(file);
        <span class="hljs-keyword">this</span>.push(file);
        next();
        <span class="hljs-keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Otherwise, grab the template and go with it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      templateReady = [config.template];
      <span class="hljs-keyword">if</span>(config.css)
        templateReady.push(config.css);
      <span class="hljs-keyword">if</span>(config[<span class="hljs-string">'public'</span>])
        templateReady.push(config[<span class="hljs-string">'public'</span>] + <span class="hljs-string">'/**/*'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Hold while we receive the template files</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      vfs.src(templateReady)
        .pipe(through2.obj(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f, e, n</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Template hile itself? Process it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> config.template == <span class="hljs-string">'string'</span> &amp;&amp; f.path == path.resolve(config.template)){
            config.template = _.template(f.contents.toString(<span class="hljs-string">'utf8'</span>));
            n();
            <span class="hljs-keyword">return</span>;
          }
          <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/\/public\//</span>.test(f.path))
            f.base = path.dirname(f.base);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Insert into the stream if not template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">this</span>.push(f);
          n();
        }.bind(<span class="hljs-keyword">this</span>), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">end</span>)</span>{
          end();</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>So, we have the template complete - do the file itself now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          wp.process(file);
          <span class="hljs-keyword">this</span>.push(file);
          next();
        }.bind(<span class="hljs-keyword">this</span>)));

    };

    <span class="hljs-keyword">return</span> through2.obj(parse);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>// Wrap reporter helper
var wrapReporter = function(reporter){
  return function(options){
    return through2.obj(function(file, enc, next){
      var warnings = JSON.parse(file.contents.toString(‘utf8’)).warnings;
      if(warnings &amp;&amp; warnings.length){
        // Don’t trust the (yahoo) reporter too much
        try{
          reporter(warnings, options);
        }catch(e){
          return this.emit(‘error’, new PluginError(‘gulp-docco’, ‘Reporter crashed!’ + e));
        }
      }
      this.push(file);
      next();
    });
  };
};</p>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>var docco = function(destination, template, infos, buildOptions){
  return gutil.combine(
    docco.parser(infos),
    // docco.reporter(),
    // docco.generator(destination, template, buildOptions)
  )();
};</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>// Yui default, provided reporter
docco.yuiReporter = wrapReporter(require(‘./lib/uglyreporter’));</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>// Our own reporter
docco.chalkReporter = wrapReporter(require(‘./lib/chalkreporter’));</p>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>// Default to chalk, nicier :)
docco.reporter = docco.chalkReporter;</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>docco.generator = streamGenerator;</p>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>docco.parser = streamParser;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-built_in">module</span>.exports = streamParser;

}());</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
