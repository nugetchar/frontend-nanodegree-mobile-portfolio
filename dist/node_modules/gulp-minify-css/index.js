"use strict";var path=require("path"),applySourceMap=require("vinyl-sourcemaps-apply"),CleanCSS=require("clean-css"),objectAssign=require("object-assign"),PluginError=require("gulp-util").PluginError,Transform=require("readable-stream/transform"),VinylBufferStream=require("vinyl-bufferstream");module.exports=function(r){return r=r||{},new Transform({objectMode:!0,transform:function(e,t,a){var i=new VinylBufferStream(function(t,a){var i=objectAssign({target:e.path},r);void 0===i.relativeTo&&(i.root||e.path)&&(i.relativeTo=path.dirname(path.resolve(r.root||e.path))),r.sourceMap!==!0&&void 0!==r.sourceMap||!e.sourceMap||(i.sourceMap=JSON.stringify(e.sourceMap));var n;e.path?(n={},n[e.path]={styles:t.toString()}):n=t.toString(),new CleanCSS(i).minify(n,function(r,t){if(r)return void a(r.join(" "));if(t.sourceMap){var i=JSON.parse(t.sourceMap);i.file=path.relative(e.base,e.path),i.sources=i.sources.map(function(r){return/^(https?:)?\/\//.test(r)?r:path.relative(e.base,r)}),applySourceMap(e,i)}a(null,new Buffer(t.styles))})}),n=this;i(e,function(r,t){r?n.emit("error",new PluginError("gulp-minify-css",r,{fileName:e.path})):(e.contents=t,n.push(e)),a()})}})};