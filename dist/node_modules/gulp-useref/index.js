"use strict";function getSearchPaths(t,r,e){return e=e.replace(/^\/+/,""),-1!==r.indexOf(",")?r.split(",").map(function(r){return path.resolve(t,r,e)}):path.resolve(t,r,e)}var gutil=require("gulp-util"),through=require("through2"),useref=require("node-useref"),path=require("path"),multimatch=require("multimatch");module.exports=function(t){return through.obj(function(r,e,i){if(r.isNull())return void i(null,r);if(r.isStream())return void i(new gutil.PluginError("gulp-useref","Streaming not supported"));var n=useref(r.contents.toString(),t),o=n[0];try{r.contents=new Buffer(o),this.push(r)}catch(u){this.emit("error",new gutil.PluginError("gulp-useref",u))}i()})},module.exports.assets=function(t){t=t||{};var r,e=require("brace-expansion"),i=require("lodash"),n=require("gulp-concat"),o=require("gulp-if"),u=require("event-stream"),a=t.types||["css","js"],s=require("is-relative-url"),h=require("vinyl-fs"),c=Array.prototype.slice.call(arguments,1),f=through.obj(),p=0,l=!1,g=[];t.additionalStreams&&(Array.isArray(t.additionalStreams)||(t.additionalStreams=[t.additionalStreams]),t.additionalStreams=t.additionalStreams.map(function(t){return t.pipe(u.through(function(t){g.push(t)}))})),t.additionalStreams?r=u.merge(t.additionalStreams).pipe(through.obj()):(r=through.obj(),r.emit("finish"));var m=through.obj(function(m,d,v){var S=this;r.pipe(u.wait(function(){var r=useref(m.contents.toString()),u=r[1];a.forEach(function(r){var a=u[r];a&&Object.keys(a).forEach(function(r){var u,f,d,v=a[r].assets;if(v.length){if(p++,d=a[r].searchPaths||t.searchPath,Array.isArray(d)||(d=e(d)),f=v.filter(s).map(function(r){return t.transformPath&&(r=t.transformPath(r)),d.length?d.map(function(t){return getSearchPaths(m.cwd,t,r)}):path.join(m.base,r)}),f=i.flatten(f,!0),u=h.src(f,{base:m.base,nosort:!0,nonull:!0}),g.forEach(function(t){multimatch(t.path,f).length>0&&u.push(t)}),g.length>0){var b={},q=0,j=[],y=[];f.forEach(function(t){b[t]=q++}),u=u.pipe(through.obj(function(t,r,e){var i=b[t.path];void 0===i?y.push(t):j[i]=t,e()},function(t){j.forEach(function(t){void 0!==t&&this.push(t)},this),y.forEach(function(t){this.push(t)},this),t()}))}c.forEach(function(t){u=u.pipe(t(r))}),u.pipe(o(!t.noconcat,n(r))).pipe(through.obj(function(t,r,e){S.push(t),e()})).on("finish",function(){0===--p&&l&&S.emit("end")})}})}),f.write(m,v)}))},function(){l=!0,0===p&&this.emit("end")});return m.restore=function(){return f.pipe(through.obj(),{end:!1})},m};